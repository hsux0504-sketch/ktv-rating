<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KTV æ­Œå”±å¤§è³½è©•åˆ†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: #1a1a2e; color: #fff; }
        .star-btn:hover { transform: scale(1.2); }
        .star-active { color: #fbbf24; } /* é‡‘é»ƒè‰² */
        .star-inactive { color: #4b5563; } /* ç°è‰² */
    </style>
</head>
<body>
    <div id="app" class="max-w-3xl mx-auto p-4 pb-20">
        
        <header class="text-center mb-8 mt-4">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">
                ğŸ¤ KTV æ­Œå”±å¤§è³½è©•åˆ†
            </h1>
            <p class="text-gray-400 mt-2">å…¬å¹³ã€å…¬æ­£ã€å…¬é–‹ (å¤§æ¦‚å•¦)</p>
        </header>

        <div v-if="loading" class="text-center py-10">è³‡æ–™è®€å–ä¸­...</div>

        <div v-if="!hasVoted && !loading">
            <p class="text-yellow-300 text-center mb-6 font-bold bg-gray-800 p-2 rounded">
                âš ï¸ æ³¨æ„ï¼šæ¯äººé™è©•åˆ†ä¸€æ¬¡ï¼Œè«‹è½å®Œå†é€å‡ºå–”ï¼
            </p>

            <div v-for="(singer, sIndex) in singers" :key="singer.name" class="mb-8 bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700">
                <h2 class="text-2xl font-bold mb-4 text-pink-400 border-b border-gray-600 pb-2">
                    ğŸ‘¨â€ğŸ¤ é¸æ‰‹ï¼š{{ singer.name }}
                </h2>

                <div v-for="songNum in 5" :key="songNum" class="mb-4">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between">
                        <span class="text-lg font-medium mb-2 sm:mb-0">ğŸµ ç¬¬ {{ songNum }} é¦–æ­Œ</span>
                        
                        <div class="flex space-x-1">
                            <button v-for="star in 6" :key="star" 
                                @click="rate(sIndex, songNum, star)"
                                class="star-btn transition-transform duration-200 text-2xl focus:outline-none"
                                :class="getStarClass(sIndex, songNum, star)"
                                :title="ratingLabels[star]">
                                â˜…
                            </button>
                        </div>
                    </div>
                    <div class="text-right text-sm text-gray-400 mt-1 h-5">
                        {{ getRatingLabel(sIndex, songNum) }}
                    </div>
                </div>
            </div>

            <button @click="submitScores" 
                class="w-full bg-gradient-to-r from-green-400 to-blue-500 hover:from-green-500 hover:to-blue-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg transform transition hover:scale-105 text-xl">
                ğŸš€ é€å‡ºè©•åˆ† (ç„¡æ³•ä¿®æ”¹)
            </button>
        </div>

        <div v-else-if="!loading" class="animate-fade-in">
            <div class="bg-gray-800 rounded-xl p-8 shadow-2xl border border-yellow-500 text-center mb-8">
                <h2 class="text-3xl font-bold text-yellow-400 mb-2">ğŸ† å³æ™‚æˆ°æ³æ’è¡Œæ¦œ ğŸ†</h2>
                <p class="text-gray-400 mb-6">æ„Ÿè¬æ‚¨çš„è©•åˆ†ï¼ä»¥ä¸‹æ˜¯ç›®å‰ç´¯ç©åˆ†æ•¸</p>

                <div class="space-y-4">
                    <div v-for="(singer, index) in sortedSingers" :key="singer.name" 
                        class="flex items-center justify-between bg-gray-700 p-4 rounded-lg relative overflow-hidden">
                        <div class="absolute left-0 top-0 bottom-0 w-2" :class="getRankColor(index)"></div>
                        
                        <div class="flex items-center ml-4">
                            <span class="text-2xl font-bold w-8 text-center mr-4">{{ index + 1 }}</span>
                            <span class="text-xl font-bold">{{ singer.name }}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-3xl font-bold text-yellow-300">{{ singer.totalScore }}</span>
                            <span class="text-xs text-gray-400 block">ç´¯ç©æ˜Ÿæ˜Ÿ</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center text-gray-500 text-sm mt-10">
                <p>é‡æ–°æ•´ç†é é¢å¯æŸ¥çœ‹æœ€æ–°åˆ†æ•¸</p>
                <p class="mt-2 text-xs">Based on Github & Firebase</p>
            </div>
        </div>

    </div>

    <script>

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_ID",
            appId: "YOUR_APP_ID"
        };

	    apiKey: "AIzaSyCRQrQyDSVmjC2xuUOrbZ2KexQbOTkHge4",
            authDomain: "ktv-score.firebaseapp.com",
            databaseURL: "https://ktv-score-default-rtdb.firebaseio.com",
            projectId: "ktv-score",
            storageBucket: "ktv-score.firebasestorage.app",
            messagingSenderId: "433112818952",
            appId: "1:433112818952:web:dc116c5bf9ec730fa278bd",
            measurementId: "G-TXJ4DCL3C7"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const loading = ref(true);
                const hasVoted = ref(false);
                
                // å®šç¾©æ­Œæ‰‹èˆ‡é è¨­è³‡æ–™
                const singers = ref([
                    { name: 'èˆ«å¦‚', scores: {}, totalScore: 0 },
                    { name: 'æ›‰ç¿”', scores: {}, totalScore: 0 },
                    { name: 'æŸ¥æŸ¥', scores: {}, totalScore: 0 },
                    { name: 'é˜¿å“²', scores: {}, totalScore: 0 },
                    { name: 'çŸ¥èª¼', scores: {}, totalScore: 0 }
                ]);

                // è©•åˆ†æ¨™æº–æ–‡æ¡ˆ
                const ratingLabels = {
                    6: "6 é¡†æ˜Ÿ è¶…å®Œç¾ ğŸ†",
                    5: "5 é¡†æ˜Ÿ å¾ˆå²å®³ ğŸŒŸ",
                    4: "4 é¡†æ˜Ÿ é‚„ä¸éŒ¯å•¦ ğŸ‘",
                    3: "3 é¡†æ˜Ÿ æ™®æ™®é€šé€š ğŸ¤",
                    2: "2 é¡†æ˜Ÿ ä½ æ˜¯å¦ä¾†ä¸åŠç·´é€™é¦–ï¼ŸğŸ˜",
                    1: "1 é¡†æ˜Ÿ é€™é¦–æˆ‘å”±çš„ï¼Œ1 é¡†æ˜Ÿè®“ä½ å€‘ ğŸ˜"
                };

                // ä½¿ç”¨è€…æš«å­˜çš„è©•åˆ† (User Local State)
                const userVotes = ref({}); 
                // çµæ§‹: { 'èˆ«å¦‚': { 1: 5, 2: 4... }, 'æ›‰ç¿”': ... }

                // åˆå§‹åŒ–ä½¿ç”¨è€…æŠ•ç¥¨æš«å­˜çµæ§‹
                singers.value.forEach(s => {
                    userVotes.value[s.name] = {};
                });

                // æª¢æŸ¥æ˜¯å¦æŠ•éç¥¨ & è®€å–é ç«¯åˆ†æ•¸
                onMounted(() => {
                    // 1. æª¢æŸ¥ LocalStorage
                    if (localStorage.getItem('ktv_voted') === 'true') {
                        hasVoted.value = true;
                    }

                    // 2. ç›£è½ Firebase è³‡æ–™åº«è®ŠåŒ– (Realtime)
                    const scoresRef = db.ref('scores');
                    scoresRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            // æ›´æ–°å‰ç«¯é¡¯ç¤ºçš„ç¸½åˆ†
                            singers.value.forEach(singer => {
                                singer.totalScore = data[singer.name] || 0;
                            });
                        }
                        loading.value = false;
                    });
                });

                // é»æ“Šæ˜Ÿæ˜Ÿ
                const rate = (sIndex, songNum, star) => {
                    const singerName = singers.value[sIndex].name;
                    userVotes.value[singerName][songNum] = star;
                };

                // å–å¾—æ˜Ÿæ˜Ÿæ¨£å¼
                const getStarClass = (sIndex, songNum, star) => {
                    const singerName = singers.value[sIndex].name;
                    const currentVote = userVotes.value[singerName][songNum] || 0;
                    return star <= currentVote ? 'star-active' : 'star-inactive';
                };

                // å–å¾—è©•èªé¡¯ç¤º
                const getRatingLabel = (sIndex, songNum) => {
                    const singerName = singers.value[sIndex].name;
                    const currentVote = userVotes.value[singerName][songNum];
                    return currentVote ? ratingLabels[currentVote] : '';
                };

                // é€å‡ºè©•åˆ†
                const submitScores = () => {
                    // æª¢æŸ¥æ˜¯å¦æ¯é¦–éƒ½è©•äº† (5äºº * 5é¦– = 25åˆ†)
                    let totalVotesCount = 0;
                    singers.value.forEach(s => {
                        totalVotesCount += Object.keys(userVotes.value[s.name]).length;
                    });

                    if (totalVotesCount < 25) {
                        alert(`ç›®å‰åªè©•äº† ${totalVotesCount}/25 æ¬¡ï¼è«‹å®Œæˆæ‰€æœ‰è©•åˆ†å†é€å‡ºã€‚`);
                        return;
                    }

                    if (!confirm("ç¢ºå®šè¦é€å‡ºåˆ†æ•¸å—ï¼Ÿé€å‡ºå¾Œç„¡æ³•ä¿®æ”¹ï¼")) return;

                    // ä½¿ç”¨ Transaction åŸå­æ“ä½œæ›´æ–°åˆ†æ•¸ (é¿å…å¤šäººåŒæ™‚å¯«å…¥è¡çª)
                    const updates = {};
                    singers.value.forEach(singer => {
                        const userTotalForSinger = Object.values(userVotes.value[singer.name]).reduce((a, b) => a + b, 0);
                        // é€™æ˜¯ Firebase ç‰¹æœ‰çš„ç´¯åŠ å¯«æ³•
                        db.ref('scores/' + singer.name).transaction((currentScore) => {
                            return (currentScore || 0) + userTotalForSinger;
                        });
                    });

                    // æ¨™è¨˜å·²æŠ•ç¥¨
                    localStorage.setItem('ktv_voted', 'true');
                    hasVoted.value = true;
                    alert("è©•åˆ†æˆåŠŸï¼æŸ¥çœ‹æ’è¡Œæ¦œå§ï¼");
                };

                // æ’è¡Œæ¦œæ’åº
                const sortedSingers = computed(() => {
                    return [...singers.value].sort((a, b) => b.totalScore - a.totalScore);
                });

                const getRankColor = (index) => {
                    if (index === 0) return 'bg-yellow-400';
                    if (index === 1) return 'bg-gray-300';
                    if (index === 2) return 'bg-orange-400';
                    return 'bg-transparent';
                };

                return {
                    singers,
                    userVotes,
                    loading,
                    hasVoted,
                    ratingLabels,
                    rate,
                    getStarClass,
                    getRatingLabel,
                    submitScores,
                    sortedSingers,
                    getRankColor
                };
            }
        }).mount('#app');
    </script>
</body>
</html>